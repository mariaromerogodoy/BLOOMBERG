<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>BLOOMBERG</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --up: lime; --down: #ff3333; }
  body { margin: 0; background:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .logo {
    position: relative; width: 100%; max-width: 900px; height: 260px;
    margin: 8vh auto; background:#000; border-radius:12px; overflow:hidden;
    box-shadow: 0 8px 30px rgba(0,0,0,.15);
  }
  #chart { position:absolute; inset:0; width:100%; height:100%; display:block; }
  .mask-layer {
    position:absolute; inset:0; background:#000;
    -webkit-mask: url(#logoMask) center/contain no-repeat;
            mask: url(#logoMask) center/contain no-repeat;
    pointer-events:none;
  }
  .hud { max-width:900px; margin: 8px auto 0; color:#222; font-size:13px; opacity:.8; }
</style>


<svg width="0" height="0" style="position:absolute">
  <defs>
    <mask id="logoMask" maskUnits="objectBoundingBox" maskContentUnits="objectBoundingBox">
      <rect x="0" y="0" width="1" height="1" fill="white"/>
      <g transform="scale(0.0005208333, 0.000925926)">
        <g fill="black">
          
        </g>
      </g>
    </mask>
  </defs>
</svg>
</head>

<body>
  <div class="logo">
    <svg id="chart" viewBox="0 0 1920 1080" preserveAspectRatio="none">
      <path id="areaFill" fill="lime" opacity="0.5"></path>
      <path id="lineStroke" stroke="lime" stroke-width="10" fill="none"></path>
    </svg>
    <div class="mask-layer"></div>
  </div>
  <div class="hud" id="status">Loading FTSE (^FTSE)…</div>

<script>

const TD_KEY = "20588a34ac984c0bb16607c5dcd4c0de";  
const TD_SYMBOL = "UKX";                
let points = [];
let lastPrice = null, currentPrice = null;

const area = document.getElementById("areaFill");
const line = document.getElementById("lineStroke");
const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = t; }


function draw() {
  const min = Math.min(...points), max = Math.max(...points);
  const stepX = 1920 / Math.max(1, points.length - 1);
  let d = "";
  for (let i=0;i<points.length;i++){
    const x = i * stepX;
    const y = 1080 - ((points[i] - min) / (max - min || 1)) * 1080;
    d += i ? `L${x},${y}` : `M${x},${y}`;
  }
  line.setAttribute("d", d);
  area.setAttribute("d", d + "L1920,1080 L0,1080 Z");

  if (lastPrice != null){
    const up = currentPrice > lastPrice;
    const color = up ? "var(--up)" : "var(--down)";
    line.setAttribute("stroke", color);
    area.setAttribute("fill", color);
  }
}


async function loadHistory(){
  setStatus("Fetching FTSE history…");
  const res = await fetch("/api/ftse");
  const json = await res.json();
  const r = json?.chart?.result?.[0];
  const closes = r?.indicators?.quote?.[0]?.close ?? [];
  points = closes.filter(v => Number.isFinite(v)).slice(-400);
  currentPrice = points.at(-1);
  draw();
  setStatus(`FTSE baseline loaded • ${currentPrice.toFixed(2)} • starting live feed…`);
}


function startLive(){
  const ws = new WebSocket(`wss://ws.twelvedata.com/v1/quotes/price?apikey=${TD_KEY}`);

  ws.addEventListener("open", () => {
    ws.send(JSON.stringify({ action:"subscribe", params:{ symbols: TD_SYMBOL }}));
    setStatus("LIVE • Streaming FTSE ticks…");
  });

  ws.addEventListener("message", evt => {
    const msg = JSON.parse(evt.data);
    const price = Number(msg?.price ?? msg?.data?.price);
    if (!Number.isFinite(price)) return;
    lastPrice = currentPrice;
    currentPrice = price;
    points.push(price);
    if (points.length > 600) points.shift();
    draw();
  });

  ws.addEventListener("close", () => setTimeout(startLive, 3000));
}


(async () => {
  await loadHistory();
  startLive();
})();
</script>
</body>
</html>
